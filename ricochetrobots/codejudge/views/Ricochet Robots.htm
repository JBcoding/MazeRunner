<!DOCTYPE html>
<html>
<head>
	<title>Ricochet Robots Runner</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
	  <style>
	  .controlButton,a{cursor:pointer;text-decoration:none}.controlButton,.controlButton:hover,a{text-decoration:none}{margin:0;padding:0}#appdiv{border:2px solid #000;width:1000px;height:500px;margin:0 auto}.canvaswrapper,.sidebar{display:inline-block;height:100%;float:left}.moveslist li,.moveslist ul,.moveslistwrapper{margin:0;padding:0}canvas{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.sidebar{position:relative;width:150px;border-left:1px solid #000}.moveslist ul,.optionsMenu{width:100%;border-top:1px solid #000}.controls{height:50px}.moveslistwrapper{position:relative;background:#fff;overflow-y:scroll;-webkit-overflow-scrolling:touch;height:400px}.moveslist li{background:#eee;list-style-type:none;border-bottom:1px solid #000;line-height:15px}.moveslist a:hover{font-size:14px}.moveslist .selected{background:#6ac152}.moveslist a{display:block;font-weight:700;text-align:center;font-size:12px;padding:4%}.optionsMenu{position:absolute;height:50px;bottom:0;display:inline-block;z-index:10}a{font-family:Arial}.controlButton{width:75px;height:25px;color:#fff;font-size:12px;background:#8b8b8b;padding:5px 10px;border:0;float:left}.controlButton:hover{background:#3cb0fd}
	 </style>
</head>
<body>
<div id="appdiv"></div>
</body>
<script type="text/javascript">
window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;Array.prototype.n=function(a){if(2!=this.length)return this;switch(a){case "U":return[this[0]-1,this[1]];case "D":return[this[0]+1,this[1]];case "L":return[this[0],this[1]-1];case "R":return[this[0],this[1]+1]}};Array.prototype.equals=function(a){return this.length==a.length&&this.every(function(b,c){return b===a[c]})};
var Board=function(){this._load({rows:2,cols:2,walls:[[" "," "],[" ","#"]],goal:[0,1],robots:[[1,0]]});this.moves=[]};Board.prototype._load=function(a){this.rows=a.rows;this.cols=a.cols;this.walls=a.walls;this.goal=a.goal.slice();this.numberOfRobots=a.robots.length;this.initialPositions=a.robots.slice();this.walls.get=function(a){return this[a[0]][a[1]]}};Board.prototype.clearMoves=function(){this.moves=[]};Board.prototype.isWall=function(a){return"#"==this.walls.get(a)};
Board.prototype.isEmpty=function(a,b){if(this.isWall(a))return!1;for(var c=0;c<b.length;c++)if(a.equals(b[c]))return!1;return!0};Board.prototype.canMove=function(a,b,c){a=a.n(b);return 0>a[0]||a[0]>=this.rows||0>a[1]||a[1]>=this.cols?!1:this.isEmpty(a,c)};Board.prototype.isProperMove=function(a,b,c){c=this.getRobotPositions(c);return this.canMove(c[a],b,c)};
Board.prototype.getRobotPositions=function(a){"undefined"==typeof a&&(a=this.moves.length);for(var b=this.initialPositions.slice(),c=0;c<a;c++)b[this.moves[c].robot]=this.moves[c].endPos.slice();c=Math.floor(a);a-=c;0<a&&(c=this.moves[c],b[c.robot]=Board.getPosition(c.startPos,c.endPos,a));return b};Board.getPosition=function(a,b,c){var d=b[0]-a[0];b=b[1]-a[1];c=Animation._smooth(c);return[a[0]+d*c,a[1]+b*c]};Board.prototype.getRobotPosition=function(a,b){return this.getRobotPositions(b)[a]};
Board.prototype.getRobotAtPosition=function(a,b){for(var c=this.getRobotPositions(b),d=0;d<c.length;d++)if(a.equals(c[d]))return d;return null};Board.prototype.appendMove=function(a,b){for(var c=this.getRobotPositions(),d=c[a].slice();this.canMove(d,b,c);)d=d.n(b);this.moves.push({robot:a,direction:b,startPos:c[a].slice(),endPos:d});return!0};Board.prototype.appendMoves=function(a){for(var b=0;b<a.length;b++)this.appendMove(a[b][0],a[b][1])};
Board.prototype.isSolved=function(a){return this.getRobotPosition(0,a).equals(this.goal)};
Board.prototype.loadBoardFile=function(a){var b=function(a){throw"PARSE ERROR: "+a;},c=a.split(/\r?\n/);a=parseInt(c.shift());(isNaN(a)||0>a)&&b("First line must be a number > 1.");var d=parseInt(c.shift());(isNaN(d)||1>d||10<d)&&b("Second line must be a number from 1-10");for(var f,e=Array.apply(null,Array(d)),h=Array(a),g=0;g<a;g++){var l=c.shift();h[g]=Array(a);l||b("Expected "+a+" rows in board, but only found "+g+" rows.");l.length<a&&b("Line "+(g+3)+" was too short. Expected "+a+" symbols, but only found "+
l.length+".");for(var m=0;m<a;m++){var k=l[m];switch(k){case " ":case "#":h[g][m]=k;break;case "G":f&&b("More than one goal/goal position defined.");f=[g,m];h[g][m]=" ";break;case "0":case "1":case "2":case "3":case "4":case "5":case "6":case "7":case "8":case "9":k=parseInt(k);k>=e.length&&b("Expected "+d+" robots in the board, but found robot with id "+k+".");e[k]&&b("Robot "+k+" defined more than once in board data.");e[k]=[g,m];break;default:b("Unexpected symbol "+k+" at (row,col)="+[g,m]+" in board data.")}}}c=
e.indexOf(void 0);0<=c&&b("Robot "+c+" was not present in board data");f||b("No goal was found in board data");this._load({rows:a,cols:a,walls:h,robots:e,goal:f});this.clearMoves()};Board.prototype.saveBoardFile=function(){for(var a="",b=this.getRobotPositions(0),a=a+(this.rows+"\n"),a=a+(this.numberOfRobots+"\n"),c=0;c<this.rows;c++){for(var d=0;d<this.cols;d++){var f=this.walls[c][d];if([c,d].equals(this.goal))f="G";else for(var e=0;e<b.length;e++)b[e].equals([c,d])&&(f=e);a+=f}a+="\n"}return a};
Board.prototype.loadMoveFile=function(a,b){if(null!=a&&"string"===typeof a)if(a=a.trim(),""===a)this.clearMoves();else{for(var c=[],d=this,f=function(a){b&&(d.clearMoves(),d.appendMoves(c));throw"PARSE ERROR: "+a;},e=a.split(/\s+/),h=0;h<e.length;h++)if(2==e[h].length){var g=parseInt(e[h][0]),l=e[h][1];(isNaN(g)||0>g||g>=this.numberOfRobots)&&f("Move "+h+' "'+g+l+'" is invalid: No such robot.');-1==["U","D","L","R"].indexOf(l)&&f("Move "+h+' "'+g+l+'" is invalid: Invalid direction.');c.push([g,l])}else f("Move "+
h+' "'+e[h]+'" is invalid.');d.clearMoves();d.appendMoves(c)}};Board.prototype.saveMoveFile=function(){for(var a="",b=0;b<this.moves.length;b++)a+=this.moves[b].robot+this.moves[b].direction+"\n";return a};
var BoardView=function(a,b){this.board=a;this.canvas=b;this.ctx=b.getContext("2d");this.pastMoves=this.selectedRobot=0;this.robotColors="#7FFF00 #6495ED red yellow #A0522D #FF69B4 #FFD700 olive slategray cyan".split(" ");this.animationTime=250;this.onSolve=function(a){setTimeout(function(){alert("Well done! You solved it in "+a+" moves!")},250)};this.repaint()};BoardView.prototype._onStateChange=function(a){console.log(a)};
BoardView.prototype.gotoState=function(a,b,c){this.currentAnimation&&this.currentAnimation.cancel();if(this.pastMoves==a)"function"==typeof b&&b();else{a=Math.min(Math.max(0,a),this.board.moves.length);var d=this.pastMoves,f=Math.abs(d-a)*this.animationTime;void 0!=c&&(f=c);var e=this;this.currentAnimation=new Animation({runTime:f,step:function(b){var c=Math.floor(e.pastMoves);e.pastMoves=d+b*(a-d);b=Math.floor(e.pastMoves);c!=b&&e._onStateChange(b)},onCancel:function(){"function"==typeof b&&b()},
onFinish:function(){"function"==typeof b&&b();if(e.board.isSolved(a))e.onSolve(a);e.currentAnimation=void 0},repaint:e.repaint.bind(e)});this.currentAnimation.start()}};BoardView.prototype.stop=function(){this.currentAnimation&&this.gotoState(Math.ceil(this.pastMoves))};
BoardView.prototype.repaint=function(){var a=this.ctx,b=this.board.rows,c=this.board.cols,d=Math.min(this.canvas.width/c,this.canvas.height/b);this.CELLSIZE=d;a.clearRect(0,0,this.canvas.width,this.canvas.height);a.fillStyle="black";a.strokeStyle="#d9d9d9";a.lineWidth=1;a.beginPath();for(var f=1;f<b;f++)a.moveTo(0,f*d),a.lineTo(c*d,f*d);a.stroke();a.beginPath();for(var e=0;e<c;e++)a.moveTo(e*d,0),a.lineTo(e*d,b*d);a.stroke();a.beginPath();for(f=0;f<b;f++)for(e=0;e<c;e++)this.board.isWall([f,e])&&
a.rect(e*d,f*d,d,d);a.fill();a.beginPath();f=this.board.goal[0];b=this.board.goal[1];a.fillStyle=this.robotColors[0];a.fillRect(b*d,f*d,d,d);b=this.board.getRobotPositions(this.pastMoves);for(f=0;f<b.length;f++)c=b[f],a.beginPath(),a.fillStyle=this.robotColors[f],a.strokeStyle="black",a.lineWidth=.05*d,a.arc((c[1]+.5)*d,(c[0]+.5)*d,d/2.2,0,2*Math.PI),a.fill(),a.stroke(),f==this.selectedRobot&&(a.beginPath(),a.lineWidth=.11*d,a.arc((c[1]+.5)*d,(c[0]+.5)*d,d/2.5,0,2*Math.PI),a.stroke()),e=.8*d,a.fillStyle=
"black",a.font=e+"px monospace",a.textAlign="center",a.fillText(f,(c[1]+.5)*d,(c[0]+.5)*d+e/3)};var Animation=function(a){this.step=a.step;this.runTime=a.runTime;this._repaint=function(){"function"==typeof a.repaint&&a.repaint()};this._onStart=function(){"function"==typeof a.onStart&&a.onStart.bind(this)()};this._onFinish=function(){"function"==typeof a.onFinish&&a.onFinish.bind(this)()};this._onCancel=function(){"function"==typeof a.onCancel&&a.onCancel.bind(this)()}};
Animation.prototype._animate=function(){if(this._cancelNow)this._onCancel();else{var a=0>=this.runTime?1:((new Date).getTime()-this.startTime)/this.runTime;1>a?(this.step(a),this._repaint(),window.requestAnimationFrame(this._animate.bind(this))):(this.step(1),this._repaint(),this._onFinish())}};Animation.prototype.start=function(){this.startTime=(new Date).getTime();this._onStart();this._animate()};
Animation.prototype.join=function(a){var b=this._onFinish,c=a.start.bind(a);this._onFinish=function(){b();c()};a.start=this.start.bind(this);this.join=a.join.bind(a);return a};Animation.prototype.merge=function(a){};Animation.prototype.cancel=function(){this._cancelNow=!0};Animation._smooth=function(a){return(2*a*Math.PI-Math.sin(2*a*Math.PI))/(2*Math.PI)};
var RRGame=function(a){this.app=a;this._initView();this.board=new Board;this.boardView=new BoardView(this.board,this.canvas);this.boardView.game=this;this._addControls();var b=this;this.boardView._onStateChange=function(a){b.movesList.children().slice(0,a+1).addClass("selected");b.movesList.children().slice(a+1).removeClass("selected");a=b.movesList.children().eq(a).position().top;var d=b.movesListWrapper.height();b.movesListWrapper.scrollTop(b.movesListWrapper.scrollTop()-(d/2-a))};this._resize()};
RRGame.prototype._initView=function(){this.canvasWrapper=$("<div>").addClass("canvaswrapper");this.canvas=document.createElement("canvas");this.canvasWrapper.html(this.canvas);this.sidebar=$("<div>").addClass("sidebar");this.controls=$("<div>").addClass("controls");this.prevButton=$("<button>").addClass("controlButton").text("Previous");this.nextButton=$("<button>").addClass("controlButton").text("Next");this.playButton=$("<button>").addClass("controlButton").text("Play");this.resetButton=$("<button>").addClass("controlButton").text("Reset");
this.controls.append(this.prevButton);this.controls.append(this.nextButton);this.controls.append(this.playButton);this.controls.append(this.resetButton);this.sidebar.append(this.controls);this.movesListWrapper=$("<div>").addClass("moveslistwrapper moveslist");this.movesList=$("<ul>");this.movesList.append($("<li><a>Initial State</a></li>").addClass("selected"));this.movesListWrapper.html(this.movesList);this.sidebar.append(this.movesListWrapper);$(this.app).html(this.canvasWrapper);$(this.app).append(this.sidebar)};
RRGame.prototype._resize=function(){var a=this.sidebar.outerWidth(),b=this.controls.outerHeight(),c=Math.min(850-a,1E3)-4;this.app.height(c);this.app.width(c+a);this.canvas.height=c;this.canvas.width=c;this.canvasWrapper.width(c);this.canvasWrapper.height(c);this.controls.height(b);this.movesListWrapper.height(c-b);this.boardView.repaint()};
RRGame.prototype._addControls=function(){var a=this;this.prevButton.click(function(){a.previous();return!1});this.nextButton.click(function(){a.next();return!1});this.playButton.click(function(){a.togglePlay();return!1});this.resetButton.click(function(){a.reset();return!1});a=this;this.movesListWrapper.on("click","li",function(b){a.gotoState($(this).index(),null,0);return!1});$(this.canvas).click(function(){window.open(a.getURL(),"_blank")});$(window).resize(this._resize.bind(this))};
RRGame.prototype.loadBoardFile=function(a){this.board.loadBoardFile(a);this.clearMoves();this.boardView.repaint()};RRGame.prototype.loadMoveFile=function(a,b){try{this.board.loadMoveFile(a,b)}finally{this.reset(0),this._updateMovesList()}};RRGame.prototype._updateMovesList=function(){this.movesList.children().slice(1).remove();for(var a=0;a<this.board.moves.length;a++)this.movesList.append($("<li><a>"+(a+1)+": "+this.board.moves[a].robot+this.board.moves[a].direction+"</a></li>"))};
RRGame.prototype.clearMoves=function(){this.reset(0);this.movesList.children().slice(1).remove();this.board.clearMoves()};RRGame.prototype.gotoState=function(a,b,c){this.boardView.gotoState(a,b,c)};RRGame.prototype.togglePlay=function(){var a=this,b=function(){a.playButton.text("Play")};"Play"==this.playButton.text()?(this.playButton.text("Stop"),this.gotoState(this.board.moves.length,b)):(this.boardView.stop(),b())};
RRGame.prototype.next=function(){this.gotoState(Math.floor(this.boardView.pastMoves+1))};RRGame.prototype.previous=function(){this.gotoState(Math.floor(this.boardView.pastMoves-1))};RRGame.prototype.reset=function(){this.gotoState(0,null,0)};RRGame.prototype.clearMoves=function(){this.loadMoveFile("")};RRGame.prototype.getURL=function(){var a={board:this.board.saveBoardFile(),moves:this.board.saveMoveFile(),pastMoves:Math.floor(this.boardView.pastMoves)};return"https://hwv.dk/rr/#"+encodeURIComponent(JSON.stringify(a))};
var game=new RRGame($("#appdiv")),input="%%%CJ:input%%%",output="%%%CJ:output%%%";try{game.loadBoardFile(input),game.loadMoveFile(output,!0)}finally{window.setTimeout(function(){game.togglePlay()},1E3)};
</script>
</html>